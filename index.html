<!doctype html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta name="description" content="Trying the best, expecting the worst.">
<meta property="og:type" content="website">
<meta property="og:title" content="Coder">
<meta property="og:url" content="http://blog.mkdef.com/index.html">
<meta property="og:site_name" content="Coder">
<meta property="og:description" content="Trying the best, expecting the worst.">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Coder">
<meta name="twitter:description" content="Trying the best, expecting the worst.">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://blog.mkdef.com/"/>





  <title> Coder </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  














  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Coder</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Trying the best, expecting the worst.</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://blog.mkdef.com/2017/05/07/odes前端改造/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="无生">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Coder">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/05/07/odes前端改造/" itemprop="url">
                  odes前端改造
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-05-07T22:20:52+08:00">
                2017-05-07
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Bulma"><a href="#Bulma" class="headerlink" title="Bulma"></a>Bulma</h2><p>Bulma是一个轻量级的前端框架，仅仅包含CSS文件，而且有很多特别酷炫的<a href="https://jenil.github.io/bulmaswatch/" target="_blank" rel="external">主题</a>。第一次看到之后就想用它来写一个前端页面，正好Odes的页面功能比较简单，而且之前实现的时候有很多地方都没有做好，正好借此机会做一个小的改造。</p>
<h3 id="替换掉Bootstrap"><a href="#替换掉Bootstrap" class="headerlink" title="替换掉Bootstrap"></a>替换掉Bootstrap</h3><p>因为之前用bootstrap其实也只是为了用它的样式而已，主要功能还是得通过jQuery完成，于是用Bulma之后，就可以毫不犹豫地干掉Bootstrap了。</p>
<p>直接在页面内插入<a href="https://cdnjs.com/libraries/bulma" target="_blank" rel="external">css链接</a>，然后将bootstrap的样式替换成bulma的样式就可以了。</p>
<p>Bootstrap是包含部分icon的，odes里也有用到，于是还需要添加<a href="https://cdnjs.com/libraries/font-awesome" target="_blank" rel="external">font-awesome的css</a>才行。</p>
<h2 id="添加面包屑导航"><a href="#添加面包屑导航" class="headerlink" title="添加面包屑导航"></a>添加面包屑导航</h2><p>之前的api里其实已经写好了类别的请求、更新的代码，不过因为样式一直调不好的原因，没有显示在界面上。</p>
<p>Bulma最近才刚刚把这个加入到<a href="https://github.com/jgthms/bulma/issues/298" target="_blank" rel="external">feature list</a>里, 所以只能自己实现。</p>
<p>实现很简单，抄自<a href="https://codepen.io/superpikar/pen/JWjZOE" target="_blank" rel="external"></a>, html代码如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&lt;ul class=&quot;breadcrumb&quot;&gt;</div><div class="line">	&lt;li&gt;&lt;/li&gt;</div><div class="line">&lt;/ul&gt;</div></pre></td></tr></table></figure></p>
<p>CSS代码</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">ul</span><span class="selector-class">.breadcrumb</span> &#123;</div><div class="line">    <span class="attribute">outline-style</span>: none;</div><div class="line">    <span class="attribute">display</span>: block;</div><div class="line">    <span class="attribute">padding</span>: <span class="number">0.75rem</span>;</div><div class="line">    <span class="attribute">padding-left</span>: <span class="number">0</span>;</div><div class="line">    <span class="attribute">background</span>: <span class="number">#fff</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="selector-tag">ul</span><span class="selector-class">.breadcrumb</span> <span class="selector-tag">li</span> &#123;</div><div class="line">    <span class="attribute">display</span>: inline-block;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="selector-tag">ul</span><span class="selector-class">.breadcrumb</span> <span class="selector-tag">li</span><span class="selector-class">.is-active</span> &#123;</div><div class="line">    <span class="attribute">color</span>: <span class="number">#848484</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="selector-tag">ul</span><span class="selector-class">.breadcrumb</span>&gt;<span class="selector-tag">li</span>+<span class="selector-tag">li</span><span class="selector-pseudo">:before</span> &#123;</div><div class="line">    <span class="attribute">padding</span>: <span class="number">0</span> <span class="number">5px</span>;</div><div class="line">    <span class="attribute">color</span>: <span class="number">#848484</span>;</div><div class="line">    <span class="attribute">content</span>: <span class="string">"/\00a0"</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="selector-tag">ul</span><span class="selector-class">.breadcrumb</span> <span class="selector-tag">li</span> <span class="selector-tag">a</span><span class="selector-pseudo">:hover</span> &#123;</div><div class="line">    <span class="attribute">text-decoration</span>: underline;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>和原版相比，就去掉了边框阴影而已。</p>
<h2 id="设备宽度"><a href="#设备宽度" class="headerlink" title="设备宽度"></a>设备宽度</h2><p>之前在手机上看，一直是网页原版等比例缩小，以为是手机浏览器没有设置正确。然后今天才发现，原来是要在页面设置不同设备采用不同的页面宽度：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1&quot;&gt;</div></pre></td></tr></table></figure>
<p>加上之后，页面就能变成移动版的宽度了，如果页面实现正确的话，页面效果要比之前好很多。</p>
<p>使用Chrome调试的时候，Console上面有一个按钮可以很方便的切换桌面版和移动版，还能选择适配不同的设备，非常方便。</p>
<h2 id="自动换行"><a href="#自动换行" class="headerlink" title="自动换行"></a>自动换行</h2><p>为了保证诗能够保留之前的段落间隔，所以展示的时候要保留换行符，之前的设置是：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">pre &#123;</div><div class="line">	white-space: pre</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这样有一个问题就是，当宽度超过页面宽度的时候，尤其是在手机上，会显示不完全。 后来发现原来有一种设置可以很方便的做到既保留原有的换行符，在长度过长的时候，又会自动换行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">pre &#123;</div><div class="line">	white-space: pre-wrap;</div><div class="line">	word-wrap: break-word;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="待完成"><a href="#待完成" class="headerlink" title="待完成"></a>待完成</h2><p>目前有两个计划。 一个是添加上目录索引，这个比较简单。 一个是添加搜索，这个调研了一下，也不是特别复杂。 争取下周能完成。</p>
<p>再就是希望能有注音和释义，这两个比较麻烦，首先是文本来源上，爬取、存储、展示感觉都不是那么简单，需要再好好考虑考虑。</p>
<p>记录一个特别赞的网站：<a href="http://graphemica.com/" target="_blank" rel="external"></a>，里面包含所有的字符，常用字有释义，中文有拼音，有各类编码等等等等，特别走心，界面也很好看。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://blog.mkdef.com/2017/04/10/基于travis和docker的持续集成/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="无生">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Coder">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/04/10/基于travis和docker的持续集成/" itemprop="url">
                  基于travis和docker的持续集成
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-04-10T18:41:27+08:00">
                2017-04-10
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>本文主要是记录一下最近在两个小项目odes和kraken中使用的持续集成技术。</p>
<h2 id="所使用的基础组件"><a href="#所使用的基础组件" class="headerlink" title="所使用的基础组件"></a>所使用的基础组件</h2><p>代码托管在Github上，使用github集成的Travis CI自动触发CI流程。在CI中自动build新的image上传到Docker Hub。然后通过sshpass远程登录server触发部署脚本。部署脚本pull新的image然后部署。</p>
<h2 id="Dockerfile"><a href="#Dockerfile" class="headerlink" title="Dockerfile"></a>Dockerfile</h2><p>由于项目都是基于python的，所以dockerfile比较简单：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">FROM ubuntu:latest</div><div class="line">MAINTAINER Shaobo Liu &lt;shaobo@mkdef.com&gt;</div><div class="line">LABEL Description=&quot;This image is used to flask-kraken&quot;</div><div class="line">RUN apt-get update -y</div><div class="line">RUN apt-get install -y python3-pip python3-dev build-essential</div><div class="line">COPY src /app</div><div class="line">COPY requirements.txt /app</div><div class="line">WORKDIR /app</div><div class="line">RUN pip3 install -r requirements.txt</div><div class="line">ENTRYPOINT [&quot;python3&quot;]</div><div class="line">CMD [&quot;app.py&quot;]</div></pre></td></tr></table></figure></p>
<p>分解一下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">FROM ubuntu:latest</div><div class="line">MAINTAINER Shaobo Liu &lt;shaobo@mkdef.com&gt;</div><div class="line">LABEL Description=&quot;This image is used to flask-kraken&quot;</div></pre></td></tr></table></figure></p>
<p>首先申明使用的基础镜像，然后写上大名表示我是维护这个镜像的作者和这个镜像的用途。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">RUN apt-get update -y</div><div class="line">RUN apt-get install -y python3-pip python3-dev build-essential</div></pre></td></tr></table></figure>
<p>安装python3，如果有其他的工具或者lib，也要写在这里。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">COPY src /app</div><div class="line">COPY requirements.txt /app</div><div class="line">WORKDIR /app</div><div class="line">RUN pip3 install -r requirements.txt</div></pre></td></tr></table></figure>
<p>复制源代码到docker里，然后切换工作目录，安装三方依赖。 有时候这里需要安装一些系统级的依赖，比如lxml或者psycopg2之类的，就需要加到前面<code>apt-get install</code>里去。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">ENTRYPOINT [&quot;python3&quot;]</div><div class="line">CMD [&quot;app.py&quot;]</div></pre></td></tr></table></figure>
<p>最后是需要执行的命令。根据docker的userguide，一个image最好只干一件事。</p>
<h2 id="Travis-CI"><a href="#Travis-CI" class="headerlink" title="Travis CI"></a>Travis CI</h2><p>在项目根目录添加<code>.travis.yml</code>来定义CI流程<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">sudo: required</div><div class="line"></div><div class="line">language: python</div><div class="line"></div><div class="line">services:</div><div class="line">  - docker</div><div class="line"></div><div class="line">python:</div><div class="line">    - &quot;3.5&quot;</div><div class="line"></div><div class="line">before_install:</div><div class="line">  - sudo apt-get update</div><div class="line">  - sudo apt-get install sshpass</div><div class="line"></div><div class="line">install: &quot;pip install -r requirements.txt&quot;</div><div class="line"></div><div class="line">script: </div><div class="line">  - python --version</div><div class="line"></div><div class="line">after_success:</div><div class="line">  - docker login -u=&quot;$DOCKER_USERNAME&quot; -p=&quot;$DOCKER_PASSWORD&quot;</div><div class="line">  - docker build -t shaobol/kraken:$TRAVIS_BRANCH-$TRAVIS_BUILD_ID . </div><div class="line">  - docker push shaobol/kraken:$TRAVIS_BRANCH-$TRAVIS_BUILD_ID;</div><div class="line">  - sshpass -p $VPS_PASSWORD ssh -o stricthostkeychecking=no root@45.32.137.234 &quot;sudo /home/saukymo/kraken/deploy.sh $TRAVIS_BRANCH-$TRAVIS_BUILD_ID&quot;</div></pre></td></tr></table></figure></p>
<p>这里就不一一分解了，具体可以参考Travis的官方文档。</p>
<p>主要介绍一下这个部分和其他部分是怎么联动的。首先Travis和Github是有集成服务的，在<code>Setting -&gt; integrations &amp; services</code>里选择添加Travis就可以了。然后在Travis上就可以设置相应的CI流程了，默认是master有新的commit就会自动触发一次CI。</p>
<p>每次CI结束后的结果可以通过<a href="https://travis-ci.org/saukymo/odes.svg?branch=master" target="_blank" rel="external">badge</a>查看。</p>
<p>重点在于测试完成后build和push docker image的过程<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">after_success:</div><div class="line">  - docker login -u=&quot;$DOCKER_USERNAME&quot; -p=&quot;$DOCKER_PASSWORD&quot;</div><div class="line">  - docker build -t shaobol/kraken:$TRAVIS_BRANCH-$TRAVIS_BUILD_ID . </div><div class="line">  - docker push shaobol/kraken:$TRAVIS_BRANCH-$TRAVIS_BUILD_ID;</div></pre></td></tr></table></figure></p>
<p>敏感信息这里全部通过Travis的Environment Variables。这样可以避免因为公开而泄露。</p>
<p>如果需要将一些敏感信息传递到image里面去，可以通过<code>--build-arg</code>参数传递进去，然后保存为环境变量，参考<a href="https://docs.docker.com/engine/reference/builder/#label" target="_blank" rel="external">reference</a></p>
<p>最后通过<code>sshpass</code>执行部署脚本，这一步也可以使用<code>ansible</code>代替。</p>
<h2 id="docker-部署脚本"><a href="#docker-部署脚本" class="headerlink" title="docker 部署脚本"></a>docker 部署脚本</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">#!/bin/bash</div><div class="line"></div><div class="line">docker pull shaobol/odes:$1</div><div class="line"></div><div class="line">if docker ps -a | grep -q odes; then</div><div class="line">    docker rm -f odes</div><div class="line">fi</div><div class="line"></div><div class="line">docker run -d --name odes -p 9000:9000 --link postgres:postgres shaobol/odes:$1</div></pre></td></tr></table></figure>
<p>脚本很简单，接收CI传过来的参数(image tag)，pull新的image，然后干掉之前的container，run一个新的。这样就完成了update整个过程。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://blog.mkdef.com/2017/04/08/在Gitlab-CI中设置kubectl实现自动部署/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="无生">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Coder">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/04/08/在Gitlab-CI中设置kubectl实现自动部署/" itemprop="url">
                  在Gitlab-CI中设置kubectl实现自动部署
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-04-08T15:29:39+08:00">
                2017-04-08
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h2><ol>
<li>Kubernetes权威指南</li>
<li><a href="http://stackoverflow.com/questions/42170380/how-to-add-users-to-kubernetes-kubectl" target="_blank" rel="external">How to Add Users to Kubernetes (kubectl)?</a></li>
<li><a href="https://kubernetes.io/docs/home/" target="_blank" rel="external">Kubernetes Documentation</a></li>
</ol>
<h2 id="实现思路"><a href="#实现思路" class="headerlink" title="实现思路"></a>实现思路</h2><p>Kubernetes集群主要由Master节点控制，Master节点又主要由其中的API Sever(kube-apiserver)提供Rest接口服务。所以我们大体思路就是在CI中配置好正确的kubectl客户端，使它能够直接连到部署的集群上，从而实现远程部署。</p>
<p>目前CI主要分为test, build, deploy等几个阶段，在build阶段就把新的image打包好并且上传到私有registry了，那么deploy阶段就只需要告诉kubernetes新的image编号，kubernetes就会自动帮我们下载新的镜像并且重新部署。</p>
<p>由于目前deploy阶段采用的runner是shell runner，使用的用户是gitlab-runner。可以理解为使用gitlab-runner用户登录到git.hupofin.tech这台机器上去，然后执行ci阶段里定义的命令。</p>
<p>所以我们需要给gitlab-runner配置一个kubectl客户端，这样一来，所有使用shell runner来执行ci的阶段都可以访问集群了</p>
<h2 id="手动完成首次部署"><a href="#手动完成首次部署" class="headerlink" title="手动完成首次部署"></a>手动完成首次部署</h2><p>首次部署应用到kubernetes不是本次的重点，可以参考kubernetes官网的交互式tutorial，很清晰。</p>
<h2 id="Service-Account"><a href="#Service-Account" class="headerlink" title="Service Account"></a>Service Account</h2><p>既然是在集群外远程访问控制集群，那么就需要一定的身份认证机制。这里采用Service Account的方式进行验证。</p>
<p>Service Account包括三个部分：<br>namespace，token和CA证书。</p>
<p>所以我们需要做的就是在集群中创建一个新的sa用于部署，然后将上面三样东西配置在kubectl客户端就可以了。</p>
<h3 id="创建一个新的SA"><a href="#创建一个新的SA" class="headerlink" title="创建一个新的SA"></a>创建一个新的SA</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">kubectl create sa shaobo</div></pre></td></tr></table></figure>
<h3 id="获得secret的名字"><a href="#获得secret的名字" class="headerlink" title="获得secret的名字"></a>获得secret的名字</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">kubectl get sa shaobo -o json | jq -r .secrets[].name</div><div class="line">- shaobo-token-rq201</div></pre></td></tr></table></figure>
<p>一个Service Account可以包含多个secret，例如刚刚我们创建一个新的SA时自动生成的secret就是用于访问API的secret。<br>同时，我们也可以自己定义其他的secret，例如在从私有registry下载镜像时可能会需要一个下载镜像的secret，使用https时需要相关证书的secret等等。</p>
<h3 id="获取CA证书"><a href="#获取CA证书" class="headerlink" title="获取CA证书"></a>获取CA证书</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">kubectl get secret $secret -o json | jq -r &apos;.data[&quot;ca.crt&quot;]&apos; | base64 -d &gt; ca.crt</div></pre></td></tr></table></figure>
<p>我们需要将<code>ca.crt</code>证书下载到CI服务器上去。</p>
<h3 id="获取token"><a href="#获取token" class="headerlink" title="获取token"></a>获取token</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">kubectl get secret $secret -o json | jq -r &apos;.data[&quot;token&quot;]&apos; | base64 -d</div></pre></td></tr></table></figure>
<h2 id="将API接口暴露到外网"><a href="#将API接口暴露到外网" class="headerlink" title="将API接口暴露到外网"></a>将API接口暴露到外网</h2><h3 id="kubectl-proxy-搭建代理"><a href="#kubectl-proxy-搭建代理" class="headerlink" title="kubectl proxy 搭建代理"></a>kubectl proxy 搭建代理</h3><p>kubernetes的API默认只有本机才能访问到的，所以我们首先需要搭建一个proxy，转发一下外网的请求，这里采用自带的<code>kubectl proxy</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">kubectl proxy --address=&apos;0.0.0.0&apos; --port=8001 --accept-hosts=&apos;^*$&apos;</div></pre></td></tr></table></figure></p>
<p>这条命令实现了这么几个功能，监听8001端口，任何ip来源的请求，所有来源都准入。集群的准入准出通过阿里云的安全组策略控制，所有我们这里直接允许所有的请求即可。</p>
<h3 id="screen-后台运行"><a href="#screen-后台运行" class="headerlink" title="screen 后台运行"></a>screen 后台运行</h3><p>然后为了保证proxy一直运行下去，通过<code>screen</code>命令保留到后台：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">screen kubectl proxy --address=&apos;0.0.0.0&apos; --port=8001 --accept-hosts=&apos;^*$&apos;</div></pre></td></tr></table></figure></p>
<p><code>ctrl + a</code> <code>ctrl + d</code> detach，进程继续后台运行</p>
<h2 id="在新的机器上配置kubectl"><a href="#在新的机器上配置kubectl" class="headerlink" title="在新的机器上配置kubectl"></a>在新的机器上配置kubectl</h2><h3 id="下载kubectl"><a href="#下载kubectl" class="headerlink" title="下载kubectl"></a>下载kubectl</h3><p><a href="https://kubernetes.io/docs/tasks/kubectl/install/" target="_blank" rel="external">Installing and Setting Up kubectl</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># Linux</div><div class="line">curl -LO https://storage.googleapis.com/kubernetes-release/release/$(curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt)/bin/linux/amd64/kubectl</div></pre></td></tr></table></figure></p>
<p>添加到用户目录里<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">chmod +x ./kubectl</div><div class="line">sudo mv ./kubectl /usr/local/bin/kubectl</div></pre></td></tr></table></figure></p>
<h3 id="设置cluster"><a href="#设置cluster" class="headerlink" title="设置cluster"></a>设置cluster</h3><p>添加一个名字叫<code>hupo</code>的集群，server这里设置为集群的ip和端口：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">kubectl config set-cluster hupo --embed-certs=true --server=http://101.██.██.██:8081 --certificate-authority=./ca.crt</div></pre></td></tr></table></figure></p>
<h3 id="设置user-credentials"><a href="#设置user-credentials" class="headerlink" title="设置user credentials"></a>设置user credentials</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">kubectl config set-credentials shaobo --token=$token</div></pre></td></tr></table></figure>
<h3 id="绑定cluster和用户"><a href="#绑定cluster和用户" class="headerlink" title="绑定cluster和用户"></a>绑定cluster和用户</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">kubectl config set-context hupo --cluster=hupo --user=shaobo --namespace=default</div></pre></td></tr></table></figure>
<h3 id="切换到刚才设置的context"><a href="#切换到刚才设置的context" class="headerlink" title="切换到刚才设置的context"></a>切换到刚才设置的context</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">kubectl config use-context hupo</div></pre></td></tr></table></figure>
<h3 id="测试一下是否完成"><a href="#测试一下是否完成" class="headerlink" title="测试一下是否完成"></a>测试一下是否完成</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">kubectl version</div></pre></td></tr></table></figure>
<h2 id="CI里使用kubectl自动部署"><a href="#CI里使用kubectl自动部署" class="headerlink" title="CI里使用kubectl自动部署"></a>CI里使用kubectl自动部署</h2><p>这里以loop-service为例，直接使用kubectl更新deployment的image设置即可。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">kubectl set image deployment/loop-service loop-service=registry-vpc.cn-beijing.aliyuncs.com/hupofintech/loop-service:$&#123;ENV&#125;-$&#123;CI_BUILD_REF:0:7&#125;</div></pre></td></tr></table></figure></p>
<p>这样做会有一个缺点，就是如果更新时服务会停止，且失败之后没有办法简单的回滚。更好的办法是采用Replication Controller实现滚动更新。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://blog.mkdef.com/2016/09/26/建立自己的ngrok服务/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="无生">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Coder">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/09/26/建立自己的ngrok服务/" itemprop="url">
                  建立自己的ngrok服务
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-09-26T22:40:09+08:00">
                2016-09-26
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><img src="/uploads/GO_16.png" alt=""></p>
<h2 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h2><p>两个需求：</p>
<ol>
<li>组里采购了一台服务器，托管在所里的机房里，但是到目前为止还没有分配外网ip，所以需要一个将本地端口暴露在外网的解决方案；</li>
<li>台式机是使用的所里的内网，但是本本用的路由。而且偶尔会需要离开工位，此时如果想用本本连到台式机，也需要将本地端口暴露到外网；</li>
</ol>
<p>用过的解决方案，都是基于ngrok的：</p>
<p>国内的ngrok.cc，其实挺好用的，虽然速度上慢了一点。但是这次升级了版本之后，配置文件的写法没有公布出来，而且如果总是变的话也不是个长久的办法。加上这次服务器被攻击，直接关闭了三天免费服务器，这一点是无法容忍的。</p>
<p>原生的ngrok.io。配置比ngrok.cc要简单一点，但是服务器在美帝，更加慢了。免费版本随机出来的域名实在太难记了，而且每次都会变。并且不能绑定自己的域名，导致这个服务就今天拿来临时用了一下。</p>
<h2 id="初步方案"><a href="#初步方案" class="headerlink" title="初步方案"></a>初步方案</h2><p>自然还是用自己的服务器转发一下比较好。不过有两个问题，第一个是自己的服务器也不稳定，第二个是自己的服务器也在美帝。所以这个方案也只能是临时。但之后所里的服务器会有外网ip了，也就不需要这个服务了。其次，之后也许可以在所里的服务器上搭一个ngrok的server，这样就能以很快的速度登录到我的机器了(也许不能的原因是要绑定域名，而这个似乎很困难）</p>
<h3 id="安装golang"><a href="#安装golang" class="headerlink" title="安装golang"></a>安装golang</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">sudo apt-get install build-essential</div><div class="line">sudo apt-get install golang</div><div class="line">sudo apt-get install mercurial</div></pre></td></tr></table></figure>
<p>然而我的<code>ubuntu</code>版本似乎太低，安装好的go是1.0的。所以要自己安装高等级的版本，我这里安装的是1.6的版本。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">sudo curl -O https://storage.googleapis.com/golang/go1.6.linux-amd64.tar.gz</div><div class="line">sudo tar -xvf go1.6.linux-amd64.tar.gz</div><div class="line">sudo mv go /usr/local</div></pre></td></tr></table></figure>
<p>然后编辑profile，将go的路劲添加到系统路径里。然而我并没有成功。于是，我采用了很暴力的解决方案：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo ln -s /usr/local/go/bin/go /usr/bin/go</div></pre></td></tr></table></figure>
<p>然后可以运行一下，查看是否安装成功:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">go version</div></pre></td></tr></table></figure>
<h3 id="下载编译ngrok"><a href="#下载编译ngrok" class="headerlink" title="下载编译ngrok"></a>下载编译ngrok</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">git clone https://github.com/inconshreveable/ngrok.git ngrok</div><div class="line">cd ngrok</div></pre></td></tr></table></figure>
<p>接下来，是生成自认证的证书，这里我直接引用人家的一段解释：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Once it has finished cloning ngrok to your local machine, there is yet another thing you will need to do before you can build and compile your very own ngrok server and client and that is to create your own self-signed SSL certificate and this is required because ngrok provides the secure tunnel via TLS and in order for both the client and server to work you will need to build and compile ngrok using your self signed SSL certificate and these are linked to each other. So you cannot connect to your self-signed ngrokd server via the official ngrok client as both the server and client need to be signed using the same certificate.</div></pre></td></tr></table></figure>
<p>然后是生成证书的命令，需要将<code>NGROK_BASE_DOMAIN</code>替换成自己的域名，例如我的就是”tunnel.mkdef.com”。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">openssl genrsa -out base.key 2048</div><div class="line">openssl req -new -x509 -nodes -key base.key -days 10000 -subj &quot;/CN=[NGROK_BASE_DOMAIN]&quot; -out base.pem</div><div class="line">openssl genrsa -out server.key 2048</div><div class="line">openssl req -new -key server.key -subj &quot;/CN=[NGROK_BASE_DOMAIN]&quot; -out server.csr</div><div class="line">openssl x509 -req -in server.csr -CA base.pem -CAkey base.key -CAcreateserial -days 10000 -out server.crt</div></pre></td></tr></table></figure>
<p>然后需要去托管域名的网站添加一条解析规则，例如我托管在DNSpod上了。<br>最后终于可以编译了！！！</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">cp base.pem assets/client/tls/ngrokroot.crt</div><div class="line">make release-server release-client</div></pre></td></tr></table></figure>
<p>生成的服务端和客户端在<code>bin</code>目录下。</p>
<h2 id="运行测试"><a href="#运行测试" class="headerlink" title="运行测试"></a>运行测试</h2><h3 id="服务端"><a href="#服务端" class="headerlink" title="服务端"></a>服务端</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">./ngrokd -tlsKey=server.key -tlsCrt=server.crt -domain=&quot;[NGROK_BASE_DOMAIN]&quot; -httpAddr=&quot;:8080&quot; -httpsAddr=&quot;:8081&quot;</div></pre></td></tr></table></figure>
<p>然后打开浏览器，访问一下你配置的网站就好了，例如“<a href="http://tunnel.mkdef.com:8080”。" target="_blank" rel="external">http://tunnel.mkdef.com:8080”。</a><br>看到提示说<code>Tunnel not found</code>就表示成功了。</p>
<h3 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h3><p>首先编写配置文件<code>ngrok.cfg</code>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">server_addr: [NGROK_BASE_DOMAIN]:4443</div><div class="line">trust_host_root_certs: false</div></pre></td></tr></table></figure>
<p>然后执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">./ngrok -subdomain testing -config=ngrok.cfg 80</div></pre></td></tr></table></figure>
<p>这样你就能通过 <code>testing.tunnel.mkdef.com:8080</code> 来访问你本地的80端口了。</p>
<p>如果是tcp连接，执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">./ngrok -config=ngrok.cfg -proto tcp 22</div></pre></td></tr></table></figure>
<p>这是会显示出一个端口，似乎是随机的，不过好在反复执行是不变的，然后通过这个端口就能登录到你的本地机器了。没有测试多次执行是什么情况。</p>
<h2 id="TODO"><a href="#TODO" class="headerlink" title="TODO"></a>TODO</h2><p>目前为止只解决了部分需求，因为这个新的外网网址实在太长了，而且端口不是默认端口，所以至少还需要一步端口转发。</p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p><a href="https://www.digitalocean.com/community/tutorials/how-to-install-go-1-6-on-ubuntu-14-04" target="_blank" rel="external">How To Install Go 1.6 on Ubuntu 14.04</a></p>
<p><a href="https://www.svenbit.com/2014/09/run-ngrok-on-your-own-server/" target="_blank" rel="external">Run Ngrok on Your Own Server Using Self-Signed SSL Certificate</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://blog.mkdef.com/2016/08/29/Git-简明指南/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="无生">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Coder">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/08/29/Git-简明指南/" itemprop="url">
                  Git 简明指南
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-08-29T14:05:57+08:00">
                2016-08-29
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Git-amp-Github-介绍"><a href="#Git-amp-Github-介绍" class="headerlink" title="Git &amp; Github 介绍"></a>Git &amp; Github 介绍</h2><p>Git首先是一个版本控制系统，它可以持续的追踪你的文件变化情况，从而通过Git，你可以将编辑过的文件恢复到之前的状态，也可以方便查看编辑前后文件内容的差异。</p>
<p>同时，Git也是一个分布式的版本控制系统，对于用户来说，主要体现在允许多个用户协同开发，同时修改代码库。</p>
<p>Github则是一个可以托管代码的平台，同时提供了Web的管理界面和一系列相关的开发服务和功能，功能稳定速度较快，所以在其上托管的项目非常之多，所以用来作为我们的项目托管平台应该是最好的选择。</p>
<h2 id="下载安装"><a href="#下载安装" class="headerlink" title="下载安装"></a>下载安装</h2><p>有各种各样的工具可以实现Git的功能，但是由于我们主要采用Github作为托管平台，首先推荐的就是Github自己的图形界面工具：<br><a href="https://desktop.github.com/" target="_blank" rel="external">Github Desktop</a></p>
<p>命令行下只要安装Git就可以了。</p>
<p>事实上，目前大部分的IDE都自带或者通过插件实现了Git的所有功能，像：IntelliJ的所有IDE(包括Android Studio)，Visual Studio， Sublime Text等等。</p>
<p>具体的使用方法请自行谷歌。其实只要掌握了基本的Git命令，各种工具其实都大同小异。</p>
<h2 id="Git基本概念"><a href="#Git基本概念" class="headerlink" title="Git基本概念"></a>Git基本概念</h2><p>首先每个都有一个远端服务器仓库，所有的代码都会最终被提交到这里。开发环境中每个开发者都会有一个本地的代码仓库，由于新的代码通常是被开发者首先添加到本地代码仓库中，然后在提交到远端服务器上，所以本地代码的版本通常都要比远端服务器新。但是，如果有其他开发者提交了新的代码到远端服务器，那么这个时候Git就会告诉你，你本地的代码落后于远端服务器版本了，那么你可以选择是否下载最新的版本。</p>
<p>除了开发环境，一个完整的环节应该还包括测试和生产环境，这两个环境的代码都应该对应于远端服务器中的某一个比较完善的版本，远远落后于服务器上的最新版本。且通常只下载代码，不提交代码，也就是它不会对服务器上的版本做任何的改变。这两个环境与我们的项目都关系不大。</p>
<h2 id="新建或者下载一个本地仓库"><a href="#新建或者下载一个本地仓库" class="headerlink" title="新建或者下载一个本地仓库"></a>新建或者下载一个本地仓库</h2><p>如果你已经有了一个本地项目，想要使用Git进行版本控制(哪怕你只是新建了一个空的文件夹，还没有任何代码也可以)，这个时候你只需要使用命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git init</div></pre></td></tr></table></figure>
<p>就可以创建一个新的Git仓库了。</p>
<p>如果你的项目已经有了一个远程的项目仓库(例如我们的代码库是：<a href="git@github.com:yubozu/Parkinson_Health.git">git@github.com:saukymo/Parkinson_Health.git</a>)，那么我们只需要复制一份远端代码库到本地就可以了，使用命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git clone git@github.com:yubozu/Parkinson_Health.git</div></pre></td></tr></table></figure>
<p>此时，默认下载的最新版本的代码，当然你也可以选择下载某一特定版本的代码，这里不多说。</p>
<h2 id="本地仓库"><a href="#本地仓库" class="headerlink" title="本地仓库"></a>本地仓库</h2><p>本地仓库由三个部分组成，首先是你的工作目录，里面是你的实际项目文件，例如代码、配置等等，第二个是暂存区(stage)，它像是一个缓存区域，你可以随时将修改过的文件添加到暂存区里来，对于这些文件的<em>最新</em>改动都会被记录下来，你可以随时查看它们和之前的区别(diff)。最后一个就是你的版本树(HEAD)了，你需要将暂存区里的改动提交到这里来(commit)，此时就好像给你的项目照了一个快照，目前所有的状态都被保存到了版本树的最前面了。</p>
<p>需要注意的是，暂存区和版本树都是用户不可见的(通常保存在项目根目录的<code>.git</code>文件夹中)，所以你可以放心的修改你的代码而不会影响到git的功能。<br><img src="/uploads/trees.png" alt=""></p>
<h2 id="一般工作流程"><a href="#一般工作流程" class="headerlink" title="一般工作流程"></a>一般工作流程</h2><p>首先，我们直接在修改本地工作目录的代码即可，开发过程与平时完全一样。当你完成一个阶段的开发(或者开发完一个小的功能，或者到了一定时间需要休息一下)时，这时就需要通过Git来提交你之前做的修改了。</p>
<h3 id="git-status"><a href="#git-status" class="headerlink" title="git status"></a>git status</h3><p>首先你需要查看一下本地文件的状态。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git status</div></pre></td></tr></table></figure>
<p>这时你将看到你的项目文件中，有哪些被添加到了暂存区中，有哪些还没有(通常是新增加的文件，因为一般来说，一个文件只要被添加到暂存区中一次，它就会一直在暂存区中，不用每次都添加进来)。</p>
<h3 id="git-diff"><a href="#git-diff" class="headerlink" title="git diff"></a>git diff</h3><p>然后你可以通过</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git diff</div></pre></td></tr></table></figure>
<p>来查看你对这些文件做了哪些修改，改动都是放在一起显示的，红色的代表以前的状态，绿色代表现在的状态。由于这些改动都是你刚刚进行的，所以应该有比较深的印象，这时你应该简单的浏览一遍，回顾一下你做了哪些改动，有没有遗漏(例如 TODO)或者多余的修改(例如 调试时多余的输出等)。</p>
<p><code>diff</code>过程命令行下不是很方便，这时候通过IDE自带的比对工具会方便一些。</p>
<h3 id="git-commit"><a href="#git-commit" class="headerlink" title="git commit"></a>git commit</h3><p>确认无误后，你就可以提交你的代码了，使用命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git commit</div></pre></td></tr></table></figure>
<p><code>commit</code>的时候需要填写你本次提交做了哪些修改，这样之后自己和别人查看时能很快了解这次提交做了哪些修改。</p>
<p>以上做的所有步骤都是在本地进行的，改动的也只是你的本地代码仓库。如果你仅仅需要一个版本控制功能，那么到这一步就可以了，但是我们的项目是托管在远端服务器上的，所以我们还需要将本地的修改提交到远端服务器上，这样其他人也就能获得和使用我们的代码了。</p>
<p>如果改动不多，我们也可以用一条命令完成提交(commit)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git commit -m &quot;This is an example commit comment.&quot;</div></pre></td></tr></table></figure>
<h3 id="git-push"><a href="#git-push" class="headerlink" title="git push"></a>git push</h3><p>使用命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git push</div></pre></td></tr></table></figure>
<p>这条命令就会将你之前在本地代码仓库进行的所有提交(commit)一次性全部添加到远程代码仓库上去。</p>
<h2 id="分支"><a href="#分支" class="headerlink" title="分支"></a>分支</h2><p>本篇教程不会写关于冲突的处理，但需要了解的是，当两个甚至多个人对同一块代码进行改动的时候，会出现冲突的情况。如果大家一直都在一起改，那么每次提交都会有冲突的可能，这样显然是效率很低的。所以，为了尽量使不同开发者之间的开发不互相影响，Git有一个分支的概念。</p>
<p><img src="/uploads/branches.png" alt=""></p>
<p>当你新建仓库的时候，默认是在”master”分支上的，你可以新建一个新的分支，在新的分支上进行开发，此时这个新分支只有你一个人在开发，是完全独立于其他开发人员的，当开发完成后，再将它们合并(merge)到主分支上(可以是master，也可以是任何约定好的分支)。这样，只有在最后合并(merge)的时候才需要处理冲突的情况。</p>
<h3 id="新建分支"><a href="#新建分支" class="headerlink" title="新建分支"></a>新建分支</h3><p>通过以下命令可以新建一个名字为<code>new_branch</code>的branch，在你第一次提交(push)代码到远端服务器上之前，这个分支不会被其他人看到。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git branch new_branch</div></pre></td></tr></table></figure>
<h3 id="列出和切换分支"><a href="#列出和切换分支" class="headerlink" title="列出和切换分支"></a>列出和切换分支</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">git branch -l</div><div class="line">git checkout new_branch</div></pre></td></tr></table></figure>
<p>第一个命令可以列出本地代码有哪些分支，第二个命令可以切换到任意一个分支。</p>
<h3 id="提交分支到远端服务器"><a href="#提交分支到远端服务器" class="headerlink" title="提交分支到远端服务器"></a>提交分支到远端服务器</h3><p>当你在这个分支上的修改完成后，你可以先按照前面的一般工作流程进行操作，当你第一次输入<code>git push</code>后，git会告诉你说这个分支在远端服务器没有对应的分支。此时你可以使用:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git push origin new_branch</div></pre></td></tr></table></figure>
<p>来设置这个分支对应的远端分支(分支采用相同的名字)，之后再提交更改的时候，直接使用<code>git push</code>即可。</p>
<h3 id="合并代码"><a href="#合并代码" class="headerlink" title="合并代码"></a>合并代码</h3><p>当你的功能开发完成之后，可以到Github网站上去提交一个合并申请(pull request)，此时其他成员就会收到你的申请，他们也可以看到你这次更新所做的所有修改。</p>
<p>此时，不管你有没有权限进行服务器端的合并(merge)操作，都建议你留一些时间(1~2天)给其他开发者，让他们来审核你的代码(Code review)。这个过程不仅能提高项目的代码质量，也是一个很好的学习编程的方式。所以，也建议你在看到其他人的合并申请(pull request)时，主动的去review他们的代码，并留下自己的comments。</p>
<h3 id="删除分支"><a href="#删除分支" class="headerlink" title="删除分支"></a>删除分支</h3><p>由于我们采用基于分支的开发流程，<code>pull request</code>被合并之后，会自动删除分支，所以一般不需要这个命令，但有时候我们可能会不小心新建一个分支，那么就可以用下面这个命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git branch -d new_branch</div></pre></td></tr></table></figure>
<h2 id="更新与合并"><a href="#更新与合并" class="headerlink" title="更新与合并"></a>更新与合并</h2><p>如果你要与其他人合作开发，在你每次开始工作前，都应该检查其他人是否有提交新的代码，如果有的话，你应该先将他们的代码下载下来。使用命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git pull</div></pre></td></tr></table></figure>
<p>此时，会将远端的最新代码覆盖到本地，那么这里有个潜在的可能会要处理冲突。</p>
<p>但是，按照我们的开发流程，我们不会提交代码到master分支，其他分支都是自己所独有的。所以理论上这个操作仅仅是更新代码到最新的版本，而不需要处理冲突。</p>
<h2 id="回滚代码"><a href="#回滚代码" class="headerlink" title="回滚代码"></a>回滚代码</h2><p>希望你永远不需要用到这个部分的功能。当你需要回到之前的某个版本时，使用命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git reset --hard</div></pre></td></tr></table></figure>
<p>此时所有没有提交的改动都会还原到上一次提交的地方。</p>
<p>再往前的回滚一般不会用到。</p>
<h2 id="写在最后"><a href="#写在最后" class="headerlink" title="写在最后"></a>写在最后</h2><p>基于Git的开发是现在最基本的开发流程，不管是用来管理个人项目，还是协同开发都是非常好用的，希望大家都能很快的掌握。学习过程肯定是很痛苦的，但是熟悉和习惯之后这些额外的操作其实代价非常小，甚至可以将commit操作当做保存操作一样频繁的使用。</p>
<p>其实这个流程对于我们这样的小团队来说，略微有一点点复杂了，但是这个流程最重要的地方其实是进行Code review。这个流程给每个人Review团队中其他人代码的机会，正如前文所说，这个过程既提高了代码质量，也提高了自己的编程水平。目前这个Review的过程不是必须的，但是希望大家都能积极的参与进来。</p>
<p>最后，这个指南肯定会有各种各样的错误和疏(sheng)漏(lue)，如果有遇到任何的问题，我们可以一起解决。如果有任何的建议，我们也可以再讨论，做出改进。</p>
<p>最后的最后，希望大家能够善于利用搜索引擎来解决编程方面的问题。如果可以报销的话，可以为大家提供谷(fan)歌(qiang)的解决方案。</p>
<h2 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h2><p><a href="http://rogerdudler.github.io/git-guide/index.html" target="_blank" rel="external">设计很棒的Git教程</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>


          
          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/uploads/avatar.jpg"
               alt="无生" />
          <p class="site-author-name" itemprop="name">无生</p>
           
              <p class="site-description motion-element" itemprop="description">Trying the best, expecting the worst.</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">19</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">53</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">无生</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    
    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  




  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  



  




	





  





  





  



  
  

  
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  


  

  

  


  

</body>
</html>
